# CMU 15-445 课程讲义
- [英文讲义](assets/cmu15-445-course/notes/)
- [英文课件](assets/cmu15-445-course/slides/)
- [RocksDB 运行原理](https://www.qtmuniao.com/2023/06/05/how-rocksdb-works/)

## 讲义01 关系模型和关系代数

数据库和数据库管理系统区别？
- 数据库代表的是有内在关联的数据集合，跟采用的数据模型、存储格式等无关，用于对现实世界某个方面建模（如课堂学生、社交网络）
- 数据库管理系统是用于管理数据库的软件，包含数据模型、存储格式等实现细节。

数据模型有关系模型、图模型、KV模型等众多模型。其代表数据库
- 关系模型：MySQL、PostgreSQL
- 图模型：Neo4j
- KV模型：Redis、LevelDB

关系模型的提出是为了解决什么问题？
1. 数据完整性，如“year”字段必须是数字格式
2. 逻辑层和物理层分离，上层采用关系结构抽象，下层具体存储方式由 DBMS 决定（本地文件or对象存储，行存or列存等）
3. 通过高级语言来描述想要访问的数据，具体执行策略交由 DBMS 确定，具有更灵活更强大的查询能力

关系模型定义了一种基于关系的数据库抽象。

什么是关系？
- 关系是一个包含属性的无序集合，是一种数据结构，比如 Student (age, name, gender)

关系和元组的区别？
- 关系是数据结构，包含多个属性，用于表示实体
- 元组是关系中的一行数据，也称为记录record、行row，是一个具体的实体

关系模型为什么能适应大部分场景，得到广泛运用？
- 关系数据结构本身足够简单直观易于学习，因为简单所以比较普适
- 结构化数据有利于数据组织、查询和分析
- 将逻辑层和物理层分离，更加灵活
- 提供了数据完整性约束
- 基于SQL的强大的查询能力

关系代数是一组运算，用于操纵关系，它接收一个或多个关系作为输入，输出一个新的关系。例如选择Select、并集Union、连接Join、投影Projection等。

## 讲义02 现代 SQL

SQL 和关系代数的区别？
- SQL是声明式语言，仅指出需要查询的数据，而不知道如何查找
- 关系代数是过程式的，它指定了 DBMS 执行的策略

嵌套查询为什么通常很难优化？// TODO

窗口函数是什么？
1. 窗口函数通过将元组进行分组，在每个分组上进行计算和聚合
2. 结果可以与其他列一同输出（不同于聚合函数会将多个元组聚合成一个元组，无法同其他列一同输出）

```sql
SELECT * FROM (
  SELECT *, RANK() OVER (PARTITION BY cid ORDER BY grade ASC) AS rank FROM enrolled
) AS ranking 
WHERE ranking.rank = 2;
```
以课程cid进行分组，每个分组内通过成绩grade进行排序，RANK() 则是该元组所在分组的排名值，因此整个SQL意思为：查找每⻔课程成绩第⼆⾼的学⽣。

ROW_NUMBER 和 RANK 函数区别？
- ROW_NUMBER 代表在分组内排序后的所在行号
- RANK 代表在分组内排序后的所在的排名，如果order by字段值相同的行，其排名也相同

公共表表达式是什么？为了解决什么问题？
- CTE 是为了简化复杂查询语句中各种嵌套查询的书写

## 讲义03和04 数据库存储

易失性存储和非易失性存储区别？
1. 易失性存储断电会丢失数据，而非易失性存储不会
2. 易失性存储是按字节寻址，而非易失性存储按块/页寻址
3. 易失性存储顺序访问和随机访问速度都很快，而非易失性存储则适合顺序访问
4. 易失性存储通常作为内存，非易失性存储通常作为磁盘

面向磁盘的 DBMS 概述
1. 在磁盘上数据被组织成页，比如：目录页、数据页、索引页
2. 页内容是 DBMS 特殊编码的二进制数据
3. 每个页都有一个唯一的页id，DBMS 中有组件专门负责页id到物理位置（文件路径和偏移量）的映射
4. 对于单文件数据库，则所有的页都被存储在一个文件中
5. 引入缓冲池组件，负责内存和磁盘之间的数据交换

DBMS 中页的概念有 3 个：
1. 硬件页（通常为 4KB）：存储设备会保证硬件页的原子写入
2. 操作系统页 (4KB)
3. 数据库页（1‑16KB）

mmap系统调用（作用类似缓冲池）
1. mmap作用是直接将文件系统内容映射到进程内存地址空间中，相当于OS来负责在磁盘和内存之间来回移动页
2. mmap如果遇到page fault（缺页异常/无访问权限），会导致进程被阻塞

DBMS 如何通过页id定位到页在磁盘上的具体位置？
1. 链表：维护两个链表，一个是数据页，一个是空闲页
2. 页目录：维护一些特殊页用于跟踪数据页和空闲页

两种主要的页布局
- slotted-page
  - 页头部记录槽数量和槽数组等信息，槽数组记录了每个元组的offset
  - 当插入一个元组的时候，槽数组将从前往后插入，元组数据将从后往前插入，当槽数组和元组数据相遇的时候说明当前页已满
- log-structured
  - append-only 只允许创建新数据⽽不允许修改旧数据
  - 将数据库修改记录存储到⽂件中（put 和 delete），每个⽇志记录都包含元组的唯⼀标识符
  - put 会产生一个记录包含整个元组，delete 也会产生一个新的记录标记其被删除
  - 为了读取记录，DBMS 会从最新到最旧的顺序向后扫描⽇志⽂件，并“重新创建”该元组
  - 落盘时会按 id 排序存储在 SSTable 中


元组布局
1. 头部：元组等元数据，并发控制数据、NULL位图等
2. 数据：元组每个属性的实际数据，通常按建表顺序存储

元组唯一标识通常为：页id + 偏移量/槽号。

五种高级数据类型
1. 整数：长度固定，如 INTEGER、BIGINT、SMALLINT、TINYINT
2. 可变精度数字：长度固定，精度可变会有舍入误差，如 FLOAT、REAL
3. 定点精度数字：可变长度，具有任意精度，带有元数据存储长度和小数点位置，如 NUMERIC、DECIMAL
4. 可变⻓度数据：任意长度，如 VARCHAR、VARBINARY、TEXT、BLOB，当元组超过单个页大小，会将数据存储在一个或多个溢出页（overflow page）上，或者存储在外部文件，然后元组包含指向该溢出页或者外部文件的指针
5. ⽇期/时间：通常被表⽰为⾃ Unix 纪元以来的某个单位时间

DBMS 会有系统目录 catalog 来存储数据库元数据，包含表和列信息等。⼤多数 DBMS 直接采用表的格式将其⽬录存储在⾃⾝内部，使⽤特殊代码来“引导”这些⽬录表。

## 讲义05 存储模型和压缩

工作负载
1. 在线事务处理OLTP：操作时间短、快速，查询简单，一次通常操作一个实体，通常写多于读
2. 在线分析处理OLAP：操作时间长，查询复杂，一次通常会操作大部分实体，读一般远多于写，通常操作OLAP上收集的数据
3. 混合事务分析处理HTAP：尝试在一个数据库上处理OLTP和OLAP

存储模型
1. 行存（N-Ary Storage Model, NSM）：一个元组所有属性连续存放到一起
  - 适合OLTP，频繁插入新实体，事务通常处理单个实体
  - 优点：可以快速插入、更新和删除；适合查询整个元组场景
  - 缺点：不适合大范围查询数据或者只查询某些列
2. 列存（Decomposition Storage Model, DSM）：所有元组的某个属性连续存放到一起
  - 适合OLAP，查询所有实体的某个属性
  - 优点：减少I/O次数，可以只查询需要的列；易于压缩
  - 缺点：不利于插入、更新和删除，因为元组所有属性被分散存储了

对于列存，通常有2种方式来查询整个元组
1. 固定长度偏移（常用）：每个列的值为固定长度，那么可以通过一个列的偏移量来推导出另一个列的偏移量
2. 嵌入元组id：每个属性存储都带有元组id，需要额外维护元组id到每个属性位置的映射

## 讲义06 缓冲池

## 讲义07 哈希表

## 讲义08 基于树的索引

## 讲义09 索引并发控制

## 讲义10 排序和聚合算法
## 讲义11 连接算法
## 讲义12 查询执行（第一部分）
## 讲义13 查询执行（第二部分）
## 讲义14 查询计划和优化
## 讲义15 并发控制理论
## 讲义16 两阶段锁
## 讲义17 时间戳排序并发控制
## 讲义18 多版本并发控制
## 讲义19 日志记录方案
## 讲义20 数据库崩溃恢复
## 讲义21 分布式数据库介绍
## 讲义22 分布式OLTP数据库
## 讲义23 分布式OLAP数据库
## 讲义24 嵌入式数据库逻辑